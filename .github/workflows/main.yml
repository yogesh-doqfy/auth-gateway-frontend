name: Deploy Angular to GCS

on:
  workflow_dispatch:  # Manually triggered
  push:
    branches:
      - master  # Change this to your deployment branch if different

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure gcloud
        run: |
          gcloud config set project crucial-context-454812-v3

      - name: Download Angular `dist` from Artifact Registry
        run: |
          gcloud artifacts files list \
            --repository=auth-gateway-frontend-cicd \
            --location=us-west2 \
            --package=my-angular-app --format="get(name)" | \
          tail -n1 | xargs -I {} gcloud artifacts files download {} --destination=dist.zip

          unzip dist.zip -d dist

      - name: Upload `dist` to GCS
        run: |
          gsutil -m rsync -r dist gs://your-bucket-name

      - name: Set Public Access (Optional)
        run: |
          gsutil iam ch allUsers:objectViewer gs://your-bucket-name

      - name: Enable Website Hosting
        run: |
          gcloud storage buckets update gs://your-bucket-name --web-site-main-page index.html

      - name: Print Deployment URL
        run: echo "App deployed at https://storage.googleapis.com/your-bucket-name/index.html"
